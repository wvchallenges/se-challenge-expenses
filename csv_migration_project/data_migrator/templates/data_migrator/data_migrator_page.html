{% extends "base_template.html" %}
{% load staticfiles %}

{% block content %}
    <div class="starter-template">
        <div class="panel panel-primary">

            <div class="panel-heading">
                <h3 class="panel-title">Data Migrator</h3>
            </div>

            <div class="panel-body">
                <p>Please use the form below to upload and submit your CSV data file.</p>
                <div class="row">
                    <div class="col-md-12">
                        <form action="/user_profile/upload_data_file" method="POST" id="file-upload-form" enctype="multipart/form-data"> {% csrf_token %}
                            <div class="input-group">
                                <span class="input-group-btn">
                                    <span class="btn btn-info btn-file">
                                        Upload File<input type="file" id="id-csv-data-file" name="csv-data-file" >
                                    </span>
                                </span>

                                <input type="text" id="file-path-id" class="form-control" placeholder="Select a CSV Data file to upload" readonly>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <div class="progress">
                            <div class="progress-bar progress-bar-success progress-bar-striped" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script type="text/javascript">
        $(document).on('change', '.btn-file :file', function() {
            var input = $(this);
            // Get the filename and strip out the rest of the basename
            label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
            // Ensure the file ends with .csv
            var regex = new RegExp("\.csv$", 'i');
            
            if (regex.test(label)) {
                $("#file-path-id").val(label);
                var data = new FormData($('form').get(0));
                $.ajax({
                    xhr: function() {
                        var xhr = new window.XMLHttpRequest();
                        xhr.upload.addEventListener("progress", function(evt) {
                          if (evt.lengthComputable) {
                            var percentComplete = evt.loaded / evt.total;
                            percentComplete = parseInt(percentComplete * 100);
                            
                            $('.progress-bar').attr("aria-valuenow", percentComplete);
                            $('.progress-bar').attr("style", "width: " + percentComplete + "%");
                            if (percentComplete === 100) {
                                $('.progress-bar').addClass("active");
                            }
                          }
                        }, false);
                        return xhr;
                    },
                    url: "/data_migrator/upload_file",
                    type: "POST",
                    data: data,
                    dataType: "json",
                    cache: false,
                    processData: false,
                    contentType: false,
                    success: function(json) {
                        alert("Successfully Uploaded your file!");
                        location.reload();
                    },
                    error : function(xhr,errmsg,err) {
                        alert("Encountered Error: " + xhr.status + ": " + xhr.responseText);
                    }
                });
            } else {
                $("#file-path-id").val('This is not a valid CSV file. Please ensure you are uploading a .csv file.');
            }
            
        });
    </script>
{% endblock %}