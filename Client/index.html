<!DOCTYPE html>
<html lang="en">

<!-- 	index.html  Wave Challenge Application (single page)

		20 Nov 2016 W. Spencer

		This page allows the user to select a file, and upload for processing.
		The file is expected to be the .CVS file provided in the Wave Challenge,
		but any similarly-formatted file will work.

		API calls made by this page:

			getUrl() - to retrieve an S3 Upload Url
			getResults() - to process the file and retrieve the processing results

 -->

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Wave Challenge</title>

    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">

   	<script src="js/jquery.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/scripts.js"></script>

	<script type="text/javascript">

	const GETURL = "https://v3sj5su3g3.execute-api.us-west-2.amazonaws.com/prod/getUrl";

	function beginUpload() {

		var fileList = document.getElementById('InputFile').files;

		// Has a file been selected?
		if (fileList.length < 1) {
			alert ("Please select a file first");
		} else {

			var rpc = new XMLHttpRequest ();
			rpc.onreadystatechange = function () {

				// We're expecting a JSon response
				if (this.readyState == 4 && this.status == 200) {

					// {"Url":"https://wavechallengedata.s3.amazonaws.com/b7fa188e-c490-4bba-9517-1c1febc3acfb",
					// "Expires":"1480086501", "Signature":"YJIYV12eWdR7WppGSb6yAbUop8E=","Uuid":"b7fa188e-c490-4bba-9517-1c1febc3acfb"}

					//console.log ("getUrl() returned", this.responseText);

					var postDetails = JSON.parse (this.responseText);
					console.log ("postDetails=", postDetails);
					//alert (postDetails.Url);

					postFile (postDetails);
				}
			}

			rpc.open("GET", GETURL);
			rpc.send();
		}
	}

	function postFile (postDetails) {

		var fileList = document.getElementById('InputFile').files;
		var selectedFile = fileList[0]; // Ignore any other files in this array

		// Build a FormData object we can transmit to save the file to S3

		var formData = new FormData();
		formData.append ("AWSAccessKeyId", postDetails.AWSAccessKeyId);
		formData.append ("Expires", postDetails.Expires);
		formData.append ("Signature", postDetails.Signature);
		formData.append ('file', selectedFile)

		// 
		var rpc = new XMLHttpRequest ();
		rpc.onreadystatechange = function () {

			// We're expecting a JSon response
			if (this.readyState == 4 && this.status == 200) {

				// {"Url":"https://wavechallengedata.s3.amazonaws.com/b7fa188e-c490-4bba-9517-1c1febc3acfb",
				// "Expires":"1480086501", "Signature":"YJIYV12eWdR7WppGSb6yAbUop8E=","Uuid":"b7fa188e-c490-4bba-9517-1c1febc3acfb"}

				//console.log ("getUrl() returned", this.responseText);

				var resp = JSON.parse (this.responseText);
				//console.log ("Parsed", resp);
				alert (resp.Url);
			}

		}

		rpc.open("PUT", postDetails.Url);
		rpc.send();
	}

	</script>

</head>

<body style="background-color: #315980">

	<!-- Amazon SDK -->
	<script src="https://sdk.amazonaws.com/js/aws-sdk-2.6.3.min.js"></script>

	<!-- Container #1 -->
	<div class="container-fluid" style="background-color: #0C81C8">

		<!-- Spacer row -->
		<div class="row p-t-0">
			<div class="col-md-12 text-center">
				&nbsp;
			</div>
		</div>

		<!-- Top row: Logo, Log In, and Signup buttons -->
		<div class="row">

			<div class="col-md-4"></div>

			<div class="col-md-4">

<!-- 				<form action="https://wavechallengedata.s3.amazonaws.com/env.js" enctype="multipart/form-data" method="PUT">
					<input type="hidden" name="AWSAccessKeyId" value="AKIAJAFRE63KT2JMTL6Q">
					<input type="hidden" name="Expires" value="1479882535">
					<input type="hidden" name="Signature" value="1Hm3Z8ToQRWQM801GZxQ4HOPRbo%3D">
					<label class="btn btn-default btn-file">
					    Browse <input type="file" style="display: none;">
					    <input type="submit">
					</label>
				</form>
 -->

<!-- 				<form>
				  	<div class="form-group">
				    	<label for="exampleInputFile">Please select your .CSV file</label>
				    	<input type="file" class="form-control-file" id="InputFile">
				  	</div>

				  	<button type="submit" class="btn btn-primary" onclick="doStuff()">Submit</button>
				</form>
 -->
			    	<label>Please select your .CSV file</label>
			    	<input type="file" id="InputFile">
				  	<button onclick="beginUpload()">Submit</button>

			</div>

			<div class="col-md-4"></div>

		</div>

	</div> <!-- End div -->

</body>
</html>
