<!DOCTYPE html>
<html lang="en">

<!-- 	index.html  Wave Challenge Application (single page)

		20 Nov 2016 W. Spencer

		This page allows the user to select a file, and upload for processing.
		The file is expected to be the .CVS file provided in the Wave Challenge,
		but any similarly-formatted file will work.

		API calls made by this page:

			getUrl() - to retrieve an S3 Upload Url and credentials
			getResults() - to process the file and retrieve the processing results

 -->

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Wave Challenge</title>

    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">

   	<script src="js/jquery.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/scripts.js"></script>

	<script type="text/javascript">

	// Page-wide variables
	const APIBASEURL = "https://v3sj5su3g3.execute-api.us-west-2.amazonaws.com/prod";
	var SELECTEDFILE = {};

	// window.onload = function () {
	// }

	// Fires when the user clicks the "Submit" button
	// This function issues an HTTP GET to our http://.../getUrl API to fetch the S3 parameters
	// that will allow us to later upload the file selected by the user
	function beginUpload() {

		var fileList = document.getElementById('InputFile').files;

		// Has a file been selected?
		if (fileList.length < 1) {
			alert ("Please select a file first");
		} else {

			SELECTEDFILE = fileList[0]; // Ignore any other files in this array

			document.getElementById ("lblPrompt").innerText = "Preparing " + SELECTEDFILE.name;

			var rpc = new XMLHttpRequest ();

			rpc.onreadystatechange = function () {

				// We're expecting a JSon response
				if (this.readyState == 4 && this.status == 200) {

					postFile (JSON.parse (this.responseText));
				}
			}

			rpc.open("GET", APIBASEURL + "/getUrl");
			rpc.send();
		}
	}

	// Fires when our call to http:://.../getUrl successfully completes
	// This function uses the details returned from getUrl to upload the 
	// selected file to S3.
	function postFile (postDetails) {

		document.getElementById ("lblPrompt").innerText = "Uploading " + SELECTEDFILE.name;

		// Build a FormData object we can transmit to save the file to S3

		var formData = new FormData();
		formData.append ("AWSAccessKeyId", postDetails.AWSAccessKeyId);
		formData.append ("Expires", postDetails.Expires);
		formData.append ("Signature", postDetails.Signature);
		formData.append ('file', SELECTEDFILE.name)

		var rpc = new XMLHttpRequest ();

		rpc.onreadystatechange = function () {

			// We're expecting a JSon response
			if (this.readyState == 4 && this.status == 200) {

				getResults (postDetails.Filename);
			}

		}

		rpc.open("PUT", postDetails.Url); // AWS S3 requires the use of PUT rather than POST
		rpc.send();
	}

	// Fires when the file upload to S3 successfully completes
	// This function issues an HTTP GET request to out http://.../getResults API
	function getResults (uuid) {

		document.getElementById ("lblPrompt").innerText = "Processing " + SELECTEDFILE.name;

		var rpc = new XMLHttpRequest ();

		rpc.onreadystatechange = function () {

			// We're expecting a JSon response
			if (this.readyState == 4 && this.status == 200) {

				showResults (JSON.parse (this.responseText));
			}
		}

		rpc.open("GET", APIBASEURL + "/getResults");;
		rpc.send();
	}

	// Fires when our call to /getResults successfully completes.
	// This function display the results provided by our call to /getResults,
	// which is a summary of the data we uploaded in the previous steps
	function showResults (resultsXml) {

		document.getElementById ("lblPrompt").innerText = "Processing " + SELECTEDFILE.name;
	} 

	// Fires when the user selects a file
	function onFileSelected () {

		document.getElementById('lblPrompt').innerText="Click 'Submit' to process the file";
		//document.getElementById("btnSubmit").prop('disabled', false);
	}

	</script>

</head>

<body style="background-color: #0C81C8">

	<!-- Amazon SDK -->
	<script src="https://sdk.amazonaws.com/js/aws-sdk-2.6.3.min.js"></script>

	<!-- Container #1 -->
	<div class="container-fluid">

		<hr>

		<div class="row">

			<div class="col-md-4"></div>

			<div class="col-md-4">

				<h2>Wave Challenge</h2>

			</div>

			<div class="col-md-4"></div>

		</div>

		<div class="row p-t-0"><div class="col-md-12">&nbsp;</div></div>

		<!-- Please select file... -->
		<div class="row">

			<div class="col-md-4"></div>

			<div class="col-md-4">

		    	<label id="lblPrompt">Please select your .CSV file</label>

			</div>

			<div class="col-md-4"></div>

		</div>

		<div class="row">

			<div class="col-md-4"></div>

			<div class="col-md-4">

		    	<input type="file" id="InputFile" onchange="onFileSelected()">

			</div>

			<div class="col-md-4"></div>

		</div>

		</div><div class="row"  style="height: 15px;"><div class="col-md-12"></div></div>

		<!-- "Submit" button -->
		<div class="row">
			<div class="col-md-4"></div>

			<div class="col-md-4">
			
			  	<button id="btnSubmit" onclick="beginUpload()">Submit</button>

			</div>

			<div class="col-md-4"></div>

		</div>

		<hr>

		<div id="resultsTable" class="hidden">		
			<div class="container">
			  <h2>Basic Table</h2>
			  <p>The .table class adds basic styling (light padding and only horizontal dividers) to a table:</p>            
			  <table class="table">
			    <thead>
			      <tr>
			        <th>Firstname</th>
			        <th>Lastname</th>
			        <th>Email</th>
			      </tr>
			    </thead>
			    <tbody>
			      <tr>
			        <td>John</td>
			        <td>Doe</td>
			        <td>john@example.com</td>
			      </tr>
			      <tr>
			        <td>Mary</td>
			        <td>Moe</td>
			        <td>mary@example.com</td>
			      </tr>
			      <tr>
			        <td>July</td>
			        <td>Dooley</td>
			        <td>july@example.com</td>
			      </tr>
			    </tbody>
			  </table>
			</div>
			<hr>
		</div>

	</div> <!-- End div -->

</body>
</html>
